<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
    <title>Fuckass Timetable</title>
    <style>
        /* ** THEME VARIABLES (Light Mode Default) ** */
        :root{
            --bg: #ffffff;
            --text: #111111;
            --card: #f7f7f8;
            --card-border: #eee;
            --muted: #9b9b9b;
            --input-bg: white;
            --input-border: #111;
            --primary-btn-bg: #111;
            --primary-btn-text: white;
            --secondary-btn-bg: #fff;
            --secondary-btn-border: #111;
            --yellow-light: #ffd54e;
            --soft-shadow: 0 6px 18px rgba(12,12,14,0.06);
            --radius: 14px;
            /* Person colors */
            --color-red: #f44336;
            --color-blue: #2196f3;
            --color-pink: #e91e63;
            --color-yellow: #ffeb3b;
            --color-darkgreen: #00796b;
        }

        /* ** DARK MODE OVERRIDES ** */
        body.dark-mode {
            --bg: #111111;
            --text: #f0f0f0;
            --card: #1c1c1e;
            --card-border: #333333;
            --muted: #b0b0b0;
            --input-bg: #2c2c2e;
            --input-border: #444;
            --primary-btn-bg: #eeeeee;
            --primary-btn-text: #111;
            --secondary-btn-bg: #1c1c1e;
            --secondary-btn-border: #444;
            --soft-shadow: 0 6px 18px rgba(0, 0, 0, 0.4);
            --yellow-light: #ffc107;
        }

        /* Base Styles */
        html,body{
            height:100%;
            margin:0;
            font-family:-apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
            background:var(--bg);
            color:var(--text); 
            overflow-x: hidden;
            transition: background 0.3s, color 0.3s;
        }
        
        body {
            display: flex;
            justify-content: center;
            align-items: center; 
            min-height: 100vh;
            overflow-y: auto;
            padding: 20px 0; 
        }
        
        .wrap{
            max-width:470px;
            width: 95%; 
            padding:16px;
            box-sizing: border-box; 
        }
        
        .title {
            font-weight:700;
            text-align:center;
            letter-spacing:-0.6px;
            margin-bottom:12px;
            position:relative;
        }
        
        /* Catchphrase Styles */
        .tag {
            /* Fix: Make the width fit the content */
            display: inline-block; /* Keep inline-block for positioning next to other inline content */
            width: fit-content; /* This is the key property */

            margin-top: 4px;
            color:#333333 !important;
            background:linear-gradient(90deg, var(--yellow-light), rgba(255,248,200,0.95));
            padding: 4px 8px;
            border-radius: 8px;
            box-shadow: var(--soft-shadow);
            opacity:0;
            animation: fadeIn 500ms ease forwards;
            font-weight: 600;
            font-size: 15px; 
            line-height: 1.2; 
            border: 1px solid rgba(0,0,0,0.1);
            animation-delay: 50ms; 
        }
        
        @keyframes fadeIn{
            from { opacity:0; transform:translateY(5px); }
            to { opacity:1; transform:translateY(0); }
        }

        /* --- START NEW ANIMATED DARK MODE TOGGLE STYLES --- */
        
        .dark-mode-toggle-container {
            position: absolute;
            left: 10px;
            top: 25px; /* Aligned with H1 center */
            transform: translateY(-50%);
            z-index: 10;
        }

        .dark-mode-toggle {
            border: 0;
            background: transparent;
            padding: 0;
            margin: 0;
            cursor: pointer;
            line-height: 0; 
            width: 28px;
            height: 28px;
        }
        
        /* Sun color in light mode, Moon color in dark mode (driven by currentColor) */
        .dark-mode-toggle__icon {
            width: 28px;
            height: 28px;
            color: var(--yellow-light); 
            transition: color .2s linear;
        }

        /* Icon color switch for dark mode */
        body.dark-mode .dark-mode-toggle__icon {
            color: var(--text); /* Changes to off-white/white in dark mode */
            opacity: 0.9;
        }
        
        .dark-mode-toggle__rays {
            transition: opacity .2s linear .2s;
        }

        /* Rays disappear in dark mode */
        body.dark-mode .dark-mode-toggle__rays {
            transition: opacity .2s linear;
            opacity: 0;
        }

        .dark-mode-toggle__cut-out {
            transition: transform .5s cubic-bezier(0.54,-0.42, 0.29, 1.3);
        }

        /* Moon phase animation */
        body.dark-mode .dark-mode-toggle__cut-out {
            transform: translateX(-30%);
            transition: transform .5s cubic-bezier(0.21, 0.17, 0.43, 1.43);
        }
        
        /* --- END NEW ANIMATED DARK MODE TOGGLE STYLES --- */


        .card { background:var(--card); border-radius:var(--radius); padding:14px; box-shadow:var(--soft-shadow); margin-bottom:12px; transition: background 0.3s, box-shadow 0.3s; }
        label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px; transition: color 0.3s;}
        
        /* Form Elements */
        select, button, input[type="text"] {
            width:100%; padding:12px 14px; border-radius:12px; border:2px solid var(--input-border); outline:none; font-size:15px;
            background:var(--input-bg); color:var(--text); box-sizing:border-box;
            min-width: 0; transition: background 0.3s, border-color 0.3s, color 0.3s;
            margin-bottom: 0; 
        }
        
        .select-group select {
            margin-bottom: 10px; 
        }

        .row{
            display:flex;
            gap:10px;
            flex-wrap: wrap; 
        }
        .row > * { 
            flex:1; 
            min-width: 100%; 
        }
        
        @media (min-width: 380px) {
            .row > * {
                min-width: 0; 
            }
        }
        
        .row select {
             margin-bottom: 8px; 
        }
        .btn { cursor:pointer; border:none; font-weight:700; background:var(--primary-btn-bg);color:var(--primary-btn-text); border-radius:12px;padding:12px; transition:transform .18s ease, background 0.3s, color 0.3s; }
        .btn:active{ transform:scale(.98); }
        #lessonBtn { background:var(--secondary-btn-bg);color:var(--text);border:2px solid var(--secondary-btn-border); }

        .result { padding:12px; margin-top:12px; border-radius:12px; background:var(--input-bg); border:1px solid var(--card-border); min-height:60px; transition: background 0.3s, border-color 0.3s; }
        .person { display:flex; gap:10px; align-items:center; padding:8px; border-radius:10px; margin-bottom:8px; }
        .swatch{width:14px;height:14px;border-radius:5px;box-shadow:0 2px 6px rgba(0,0,0,0.06);}
        .muted{color:var(--muted);font-size:13px}
        .extra { margin-top:8px; display:flex; gap:8px; }
        .small { padding:8px 10px; font-size:14px; border-radius:10px; background:var(--input-bg); border:1px solid var(--card-border); color:var(--text); cursor:pointer; transition: background 0.3s, border-color 0.3s, color 0.3s; }
        .collapse { max-height:0; overflow:hidden; transition:max-height .35s cubic-bezier(.2,.9,.3,1); }
        .collapse.open { max-height:420px; }
        hr { border-top-color: var(--card-border) !important; transition: border-top-color 0.3s; }

        .person { transform: translateY(6px); opacity:0; animation: personIn .35s forwards; }
        /* Staggered delay for person list */
        .person:nth-child(2){ animation-delay:50ms } 
        .person:nth-child(3){ animation-delay:100ms }
        .person:nth-child(4){ animation-delay:150ms } 
        .person:nth-child(5){ animation-delay:200ms } 
        @keyframes personIn { to{ transform:none; opacity:1 } from { transform:translateY(6px); opacity:0 } }

        /* Custom Message Modal Styles */
        #confirmModal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(10,10,10,0.55); z-index:2000; }
        .modal{ width:90%; max-width:420px; background:var(--card); border-radius:12px; padding:14px; box-shadow:var(--soft-shadow); color:var(--text); transition: background 0.3s; }
        .tiny{font-size:13px;color:var(--muted); margin-top:8px}
        
        /* Schedule Modal Styles */
        .scheduleModalBack {
            position: fixed;
            inset: 0;
            background: rgba(10, 10, 10, 0.75);
            z-index: 1010;
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }
        .scheduleModal {
            width: 90%;
            max-width: 400px;
            max-height: 80vh; 
            background: var(--card);
            border-radius: 18px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow-y: auto; 
            transition: background 0.3s;
        }
        .scheduleHeader {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .scheduleRow{ display: flex; gap: 8px; margin: 6px 0; align-items: center; }
        .scheduleCell{ padding: 8px; border-radius: 8px; border: 1px solid var(--card-border); text-align: left; background: var(--input-bg); transition: background 0.3s; }
        .pnum { width: 50px; text-align: center; font-weight: 600; flex-shrink: 0; background: var(--card); color: var(--text); border: 1px solid var(--card-border); }
        .subj { flex-grow: 1; }
        
        .modalClose {
            font-size: 24px;
            font-weight: 300;
            cursor: pointer;
            color: var(--muted);
        }
        
        @media (max-width:420px){
            .wrap{
                padding:12px;
            }
            .title h1{font-size:26px}
        }
    </style>
</head>
<body>
    <div class="wrap">
        <div class="title card">
            

<div class="dark-mode-toggle-container">
                <button id="darkModeToggle" class="dark-mode-toggle" aria-label="Toggle Dark Mode">
                    <svg class="dark-mode-toggle__icon" width="28" height="28" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <defs>
                            <mask id="mask">
                                <rect x="0" y="0" width="100%" height="100%" fill="white" />
                                
<circle class="dark-mode-toggle__cut-out" r="6" cx="24" cy="10" fill="black" />
                            </mask>
                        </defs>
                        
<circle class="dark-mode-toggle__center-circle" r="6" cx="12" cy="12" fill="currentColor" mask="url(#mask)" />
                        
                        
<g class="dark-mode-toggle__rays" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                            <line x1="12" x2="12" y1="3" y2="1" />
                            <line x1="21" x2="23" y1="12" y2="12" />
                            <line x1="12" x2="12" y1="21" y2="23" />
                            <line x1="1" x2="3" y1="12" y2="12" />
                        </g>
                        
<g class="dark-mode-toggle__rays" stroke="currentColor" stroke-width="2" stroke-linecap="round" transform="rotate(45 12 12)">
                            <line x1="12" x2="12" y1="3" y2="1" />
                            <line x1="21" x2="23" y1="12" y2="12" />
                            <line x1="12" x2="12" y1="21" y2="23" />
                            <line x1="1" x2="3" y1="12" y2="12" />
                        </g>
                    </svg>
                </button>
            </div>
            
            
<h1 style="font-size:28px; margin: 0 0 4px 0; font-weight:700;">Fuckass Timetable</h1>
            
            
<div id="randomTag" class="tag" aria-hidden="true"></div>
        </div>

        <div class="card">
            <div class="select-group">
                <label>Week</label>
                <select id="weekSelect"></select>
            </div>

            <div class="select-group">
                <label style="margin-top:10px">Day</label>
                <select id="daySelect"></select>
            </div>

            <div class="select-group">
                <label style="margin-top:10px">Period</label>
                <select id="periodSelect">
                    <option value="1">Period 1</option>
                    <option value="2">Period 2</option>
                    <option value="3">Period 3</option>
                    <option value="4">Period 4</option>
                    <option value="5">Period 5</option>
                </select>
            </div>

            <div style="display:flex; gap:10px; margin-top:12px;">
                <button class="btn" id="checkBtn">Check who's free</button>
                <button class="btn" id="lessonBtn" style="background:var(--secondary-btn-bg);color:var(--text);border:2px solid var(--secondary-btn-border);">Who has a lesson</button>
            </div>

            <div id="resultArea" class="result"></div>
        </div>

        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div><strong>Extra features</strong><div class="tiny">Add catchphrase / What do I have today</div></div>
                <button id="toggleExtra" class="small">Show</button>
            </div>

            <div id="extraPanel" class="collapse">
                <div style="margin-top:12px;">
                    <label>Add a catchphrase</label>
                    <input type="text" id="phraseInput" placeholder="Type phrase...">
                    <div style="display:flex; gap:8px; margin-top:8px;">
                        <button id="addPhraseBtn" class="small">Add phrase</button>
                        <button id="refreshTag" class="small">Refresh random tag</button>
                    </div>
                </div>

                <hr style="margin:12px 0;border:none;border-top:1px solid var(--card-border);">

                <div>
                    <label>What do I have today?</label>
                    <div class="row">
                        <select id="whoSelect"></select>
                        <select id="weekSelect2"></select>
                    </div>
                    <select id="daySelect2" style="margin-top:8px;width:100%"></select>
                    <button id="whatBtn" class="btn" style="margin-top:10px">Show my day</button>
                </div>
            </div>
        </div>

        <div style="text-align:center; color:var(--muted); font-size:13px; margin-top:8px">Made for iPhone — © Alessandro 2025</div>
    </div>

    <!-- Custom Modal for Alerts/Confirmations (hidden by default) -->
    <div id="confirmModal" style="display:none;"></div>

    <!-- Schedule Display Modal (hidden by default) -->
    <div id="scheduleModalBack" class="scheduleModalBack">
        <div id="scheduleModal" class="scheduleModal">
            <div class="scheduleHeader">
                <h3 id="scheduleTitle" style="margin:0;">Schedule</h3>
                <span id="scheduleClose" class="modalClose">&times;</span>
            </div>
            <div id="modalScheduleContent">
                <!-- Schedule rows populated by JavaScript -->
            </div>
        </div>
    </div>

<!-- The script that handles all the Firebase data, button clicks, and logic -->
<script type="module">
// Firebase Imports (MUST use cdn links provided by the environment)
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, doc, setDoc, onSnapshot, collection, updateDoc, arrayUnion, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

// Global Variables
let db;
let auth;
let userId = null;
let isAuthReady = false;
let peopleData = [];
let timetableData = {};
let currentCatchphrases = [];

// --- Embedded Timetable Data (from timetable.json) ---
const EMBEDDED_TIMETABLE_DATA = {
  "Alex": {
    "color": "blue",
    "Week 1": {
      "Monday": ["Business", "Sociology", "Psychology", "Period 4", "Period 5"],
      "Tuesday": ["Media", "Business", "Sociology", "Psychology", "Sociology"],
      "Wednesday": ["Period 1", "TPE", "Psychology", "Media", "Business"],
      "Thursday": ["Psychology", "Sociology", "Psychology", "Business", "Media"],
      "Friday": ["Period 1", "Media", "Business", "Period 4", "Sociology"]
    },
    "Week 2": {
      "Monday": ["Business", "Sociology", "Psychology", "Business Lesson 10", "Media"],
      "Tuesday": ["Media", "Business", "TPE", "Citizenship", "Psychology"],
      "Wednesday": ["Period 1", "Sociology", "Psychology", "Media", "Business"],
      "Thursday": ["Psychology", "Sociology", "Psychology", "Business", "Sociology"],
      "Friday": ["Period 1", "Media", "Business", "Period 4", "Sociology"]
    }
  },
  "Oliwia": {
    "color": "pink",
    "Week 1": {
      "Monday": ["Maths", "Sociology", "Media Lesson 10", "Psychology Lesson 10", "Period 5"],
      "Tuesday": ["Maths", "TPE", "Media Lesson 10", "Psychology", "Period 5"],
      "Wednesday": ["Maths", "Psychology", "Sociology", "Sociology", "Maths"],
      "Thursday": ["Psychology", "Maths", "Media", "Maths", "Sociology"],
      "Friday": ["Maths", "Sociology", "Media", "Psychology", "Sociology"]
    },
    "Week 2": {
      "Monday": ["Maths", "Sociology", "Media Lesson 10", "Psychology Lesson 10", "Period 5"],
      "Tuesday": ["Sociology", "Maths", "TPE", "Citizenship", "Psychology"],
      "Wednesday": ["Maths", "TPE", "Psychology", "Sociology", "Maths"],
      "Thursday": ["Psychology", "Maths", "Media", "Maths", "Sociology"],
      "Friday": ["Maths", "Sociology", "Media", "Psychology", "Sociology"]
    }
  },
  "Prinson": {
    "color": "darkgreen",
    "Week 1": {
      "Monday": ["EQA", "Chemistry Lesson 10", "Biology", "Psychology Lesson 10", "Health & Social Care"],
      "Tuesday": ["Biology", "Chemistry", "Chemistry", "Psychology", "Health & Social Care"],
      "Wednesday": ["EQA", "TPE", "Psychology", "Biology", "Chemistry"],
      "Thursday": ["Psychology", "Chemistry", "Chemistry", "Biology", "Biology"],
      "Friday": ["EQA", "Chemistry", "Chemistry", "Biology", "Psychology"]
    },
    "Week 2": {
      "Monday": ["EQA", "Chemistry", "Psychology", "Biology Lesson 10", "Health & Social Care"],
      "Tuesday": ["Biology", "Chemistry", "Chemistry", "Citizenship", "Psychology"],
      "Wednesday": ["EQA", "Chemistry", "Psychology", "Biology", "Chemistry"],
      "Thursday": ["Psychology", "Chemistry", "Chemistry", "Biology", "Biology"],
      "Friday": ["EQA", "Chemistry", "Chemistry", "Biology", "Psychology"]
    }
  },
  "Hanan": {
    "color": "red",
    "Week 1": {
      "Monday": ["EPQ", "Sociology", "Media Lesson 10", "CTEC Business", "Health & Social Care"],
      "Tuesday": ["Media", "Health & Social Care", "Media", "Sociology", "CTEC Business"],
      "Wednesday": ["Health & Social Care", "CTEC Business", "CTEC Business Lesson 10", "Media", "Sociology"],
      "Thursday": ["CTEC Business", "Sociology", "CTEC Business", "Maths re-take", "Health & Social Care"],
      "Friday": ["CTEC Business", "Sociology", "Media", "Period 4", "Sociology"]
    },
    "Week 2": {
      "Monday": ["EPQ", "Sociology", "Media Lesson 10", "CTEC Business", "Health & Social Care"],
      "Tuesday": ["Media", "Health & Social Care", "TPE", "Citizenship", "CTEC Business"],
      "Wednesday": ["Health & Social Care", "Sociology", "CTEC Business", "Media", "Sociology"],
      "Thursday": ["CTEC Business", "Sociology", "Sociology", "Maths", "Media"],
      "Friday": ["CTEC Business", "Sociology", "Media", "Period 4", "Sociology"]
    }
  },
  "Hannah": {
    "color": "yellow",
    "Week 1": {
      "Monday": ["EPQ", "Media", "Biology Lesson 10", "CTEC Business", "Health & Social Care"],
      "Tuesday": ["Media", "Health & Social Care", "Health & Social Care", "CTEC Business", "CTEC Business"],
      "Wednesday": ["Health & Social Care", "Health & Social Care", "CTEC Business Lesson 10", "Media", "Media"],
      "Thursday": ["CTEC Business", "Sociology", "CTEC Business", "Maths", "Media"],
      "Friday": ["CTEC Business", "Sociology", "Media", "Health & Social Care", "Health & Social Care"]
    },
    "Week 2": {
      "Monday": ["EPQ", "Media", "Biology Lesson 10", "CTEC Business", "Health & Social Care"],
      "Tuesday": ["Media", "Health & Social Care", "Citizenship", "Citizenship", "CTEC Business"],
      "Wednesday": ["Health & Social Care", "maths re-take", "CTEC Business", "Media", "TPE"],
      "Thursday": ["CTEC Business", "Sociology", "CTEC Business", "Maths", "Media"],
      "Friday": ["CTEC Business", "Sociology", "Media", "Health & Social Care", "Health & Social Care"]
    }
  }
};
// --- END Embedded Timetable Data ---


// --- Configuration and Initialization ---

// Mandatory Canvas environment variables
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

// The app will use the embedded data by default
timetableData = EMBEDDED_TIMETABLE_DATA;
const PEOPLE_NAMES = Object.keys(timetableData);


/**
 * Sets up Firebase Authentication and Firestore.
 */
const setupFirebase = async () => {
    setLogLevel('error'); // Set log level to 'error' to avoid noisy console output

    if (!firebaseConfig) {
        console.error("Firebase config is missing. Running in local mock data mode.");
        // If config is missing, the app will run with the embedded data and no persistence.
        userId = 'local-user';
        isAuthReady = true;
        // Proceed with initial UI updates using local data
        updateCatchphraseUI();
        initSelectors();
        return;
    }

    try {
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);

        // Sign in with custom token or anonymously
        if (initialAuthToken) {
            await signInWithCustomToken(auth, initialAuthToken);
        } else {
            await signInAnonymously(auth);
        }

        // Wait for auth state to be confirmed
        onAuthStateChanged(auth, (user) => {
            if (user) {
                userId = user.uid;
                console.log("Authenticated as:", userId);
            } else {
                // Should not happen if signInAnonymously succeeded
                userId = 'anonymous-user';
                console.warn("User state changed to signed out.");
            }
            isAuthReady = true;
            
            // Start listening for data once auth is ready
            subscribeToCatchphrases();
            initSelectors(); // Initialize selectors once we have people names
        });

    } catch (error) {
        console.error("Firebase setup failed:", error);
        userId = 'firebase-error-fallback';
        isAuthReady = true;
        updateCatchphraseUI();
        initSelectors();
    }
};

/**
 * Initializes the week and day selectors on the main form.
 */
const initSelectors = () => {
    const weekSelect = document.getElementById('weekSelect');
    const daySelect = document.getElementById('daySelect');
    const weekSelect2 = document.getElementById('weekSelect2');
    const daySelect2 = document.getElementById('daySelect2');
    const whoSelect = document.getElementById('whoSelect');
    
    // Clear previous options
    weekSelect.innerHTML = '';
    daySelect.innerHTML = '';
    weekSelect2.innerHTML = '';
    daySelect2.innerHTML = '';
    whoSelect.innerHTML = '';
    
    const weeks = ["Week 1", "Week 2"];
    const days = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"];

    // Populate Week Selectors
    weeks.forEach(week => {
        const opt1 = new Option(week, week);
        const opt2 = new Option(week, week);
        weekSelect.add(opt1);
        weekSelect2.add(opt2);
    });

    // Populate Day Selectors
    days.forEach(day => {
        const opt1 = new Option(day, day);
        const opt2 = new Option(day, day);
        daySelect.add(opt1);
        daySelect2.add(opt2);
    });
    
    // Populate Who Selectors for "What do I have today?"
    PEOPLE_NAMES.forEach(name => {
        whoSelect.add(new Option(name, name));
    });
};

// --- Firebase Catchphrase Data Management ---

/**
 * Subscribes to the public catchphrases collection for real-time updates.
 */
const subscribeToCatchphrases = () => {
    if (!db || !userId || !isAuthReady) return;

    const phrasesRef = doc(db, 'artifacts', appId, 'public', 'data', 'catchphrases', 'global');

    onSnapshot(phrasesRef, (docSnap) => {
        if (docSnap.exists()) {
            const data = docSnap.data();
            // Ensure catchphrases is an array, defaulting to an empty array
            currentCatchphrases = data.phrases || [];
            updateCatchphraseUI();
        } else {
            console.log("Catchphrases document does not exist. Initializing.");
            currentCatchphrases = [];
            // Optional: Create the document if it doesn't exist
            setDoc(phrasesRef, { phrases: [] }, { merge: true }).catch(e => console.error("Error creating catchphrase doc:", e));
        }
    }, (error) => {
        console.error("Error subscribing to catchphrases:", error);
    });
};

/**
 * Adds a new phrase to the public Firestore list.
 */
const handleAddPhrase = async () => {
    const phraseInput = document.getElementById('phraseInput');
    const newPhrase = phraseInput.value.trim();
    
    if (!newPhrase) {
        showMessageModal('Validation Error', 'Please enter a catchphrase before trying to save it.');
        return;
    }

    if (!db || !userId) {
        showMessageModal('Error', 'Application is not connected to the database. Phrase cannot be saved.');
        return;
    }

    try {
        const phrasesRef = doc(db, 'artifacts', appId, 'public', 'data', 'catchphrases', 'global');
        
        await updateDoc(phrasesRef, {
            phrases: arrayUnion(newPhrase)
        });

        phraseInput.value = ''; // Clear input on success
        showMessageModal('Success', 'Catchphrase added! It will now appear randomly for all users.');
    } catch (error) {
        console.error("Error adding catchphrase:", error);
        showMessageModal('Database Error', 'Could not add phrase. Please check the console for details.');
    }
};


/**
 * Updates the random catchphrase display on the UI.
 */
const updateCatchphraseUI = () => {
    const tagElement = document.getElementById('randomTag');
    if (currentCatchphrases.length > 0) {
        const randomIndex = Math.floor(Math.random() * currentCatchphrases.length);
        tagElement.textContent = currentCatchphrases[randomIndex];
        tagElement.style.opacity = 1; // Ensure it's visible if phrases exist
    } else {
        tagElement.textContent = "Your Timetable Buddy";
        tagElement.style.opacity = 0.5; // Muted if no custom phrases
    }
};

// --- Main Timetable Logic ---

/**
 * Checks who is free in the selected period.
 * @param {boolean} checkFree - True to find free people, False to find people with a lesson.
 */
const checkTimetable = (checkFree) => {
    const week = document.getElementById('weekSelect').value;
    const day = document.getElementById('daySelect').value;
    const period = parseInt(document.getElementById('periodSelect').value, 10);
    const resultArea = document.getElementById('resultArea');
    resultArea.innerHTML = '';
    
    // Period index is 0-based, so subtract 1
    const periodIndex = period - 1;
    
    const matchedPeople = [];

    // Iterate through all people in the timetable data
    for (const personName of PEOPLE_NAMES) {
        const personData = timetableData[personName];
        
        // Safety check for week/day data existence
        if (personData && personData[week] && personData[week][day]) {
            const lesson = personData[week][day][periodIndex] || 'Period is empty/undefined';
            
            // A person is considered "free" if the lesson string is empty or contains "Period X"
            const isFree = lesson.trim() === "" || lesson.toLowerCase().includes('period');
            
            const shouldInclude = checkFree ? isFree : !isFree;
            
            if (shouldInclude) {
                matchedPeople.push({
                    name: personName,
                    color: personData.color,
                    lesson: lesson.trim() || (isFree ? 'Free' : 'Unknown Lesson') // Use 'Free' if free and lesson was empty string
                });
            }
        }
    }

    renderResult(resultArea, matchedPeople, checkFree);
};

/**
 * Renders the results of the timetable check.
 * @param {HTMLElement} container - The element to render results into.
 * @param {Array<Object>} people - The list of people who matched the criteria.
 * @param {boolean} checkFree - True if checking for free people.
 */
const renderResult = (container, people, checkFree) => {
    const action = checkFree ? 'Free' : 'In Lesson';
    const totalCount = people.length;
    
    if (totalCount === 0) {
        container.innerHTML = `<div class="muted">No one is ${action.toLowerCase()} at this time.</div>`;
        return;
    }

    let html = `<div style="margin-bottom: 10px;">
                    <strong>${totalCount} Person${totalCount !== 1 ? 's' : ''} ${action}</strong>
                </div>`;

    people.forEach((person, index) => {
        const lessonDisplay = person.lesson === 'Free' || checkFree ? `<span class="muted">${person.lesson}</span>` : `<strong>${person.lesson}</strong>`;
        
        html += `
            <div class="person" style="animation-delay:${index * 50}ms;">
                <div class="swatch" style="background:var(--color-${person.color});"></div>
                <div style="flex-grow:1;">
                    ${person.name}
                </div>
                <div>
                    ${lessonDisplay}
                </div>
            </div>
        `;
    });

    container.innerHTML = html;
};


// --- Daily Schedule Feature ---

/**
 * Displays the full daily schedule for a selected person, week, and day in a modal.
 */
const handleShowDailySchedule = () => {
    const personName = document.getElementById('whoSelect').value;
    const week = document.getElementById('weekSelect2').value;
    const day = document.getElementById('daySelect2').value;
    
    if (!personName || !week || !day) {
        showMessageModal('Input Missing', 'Please select a person, week, and day.');
        return;
    }

    const personData = timetableData[personName];
    const daySchedule = personData?.[week]?.[day];

    if (!daySchedule || !Array.isArray(daySchedule)) {
        showMessageModal('Data Error', `No schedule found for ${personName} on ${day} (${week}).`);
        return;
    }
    
    const modalTitle = document.getElementById('scheduleTitle');
    const modalContent = document.getElementById('modalScheduleContent');
    const modalBack = document.getElementById('scheduleModalBack');

    modalTitle.textContent = `${personName}'s Schedule on ${day} (${week})`;
    modalContent.innerHTML = ''; // Clear previous content

    daySchedule.forEach((lesson, index) => {
        const periodNum = index + 1;
        const subject = lesson.trim() || "Free";
        
        const row = document.createElement('div');
        row.className = 'scheduleRow';
        row.innerHTML = `
            <div class="scheduleCell pnum">P${periodNum}</div>
            <div class="scheduleCell subj">${subject}</div>
        `;
        modalContent.appendChild(row);
    });

    modalBack.style.display = 'flex'; // Show the modal
};


// --- UI / Utility Functions ---

/**
 * Toggles the visibility of the extra features panel.
 */
const toggleExtraPanel = () => {
    const panel = document.getElementById('extraPanel');
    const button = document.getElementById('toggleExtra');
    const isOpen = panel.classList.toggle('open');
    button.textContent = isOpen ? 'Hide' : 'Show';
};

/**
 * Displays a custom alert/confirmation modal (since window.alert is disallowed).
 * This function serves as a non-blocking alert for the user.
 * @param {string} title - The title of the message.
 * @param {string} message - The message content.
 */
const showMessageModal = (title, message) => {
    const modalContainer = document.getElementById('confirmModal');
    
    modalContainer.innerHTML = `
        <div class="modal">
            <h3 style="margin-top:0;">${title}</h3>
            <p>${message}</p>
            <button class="btn" onclick="document.getElementById('confirmModal').style.display='none'" style="margin-top:10px;">OK</button>
        </div>
    `;
    modalContainer.style.display = 'flex';
};


// --- Dark Mode Logic ---

const loadDarkModePreference = () => {
    // Check if the user has a preference saved, or respects the system preference
    const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    const storedPreference = localStorage.getItem('darkMode');
    
    let isDarkMode = false;
    if (storedPreference !== null) {
        isDarkMode = storedPreference === 'true';
    } else if (prefersDark) {
        isDarkMode = true;
    }

    if (isDarkMode) {
        document.body.classList.add('dark-mode');
    }
};

const toggleDarkMode = () => {
    const isDarkMode = document.body.classList.toggle('dark-mode');
    localStorage.setItem('darkMode', isDarkMode);
};


// --- Event Listeners and Setup ---

const setupEventListeners = () => {
    // Timetable Check Buttons
    document.getElementById('checkBtn').addEventListener('click', () => checkTimetable(true)); // Check free
    document.getElementById('lessonBtn').addEventListener('click', () => checkTimetable(false)); // Check lesson
    
    // Extra Panel Toggle
    document.getElementById('toggleExtra').addEventListener('click', toggleExtraPanel);

    // Catchphrase Feature
    document.getElementById('addPhraseBtn').addEventListener('click', handleAddPhrase);
    document.getElementById('refreshTag').addEventListener('click', updateCatchphraseUI);

    // Daily Schedule Feature
    document.getElementById('whatBtn').addEventListener('click', handleShowDailySchedule);
    document.getElementById('scheduleClose').addEventListener('click', () => {
        document.getElementById('scheduleModalBack').style.display = 'none';
    });

    // Dark Mode Toggle
    document.getElementById('darkModeToggle').addEventListener('click', toggleDarkMode);
};

// --- Execution ---

window.onload = async () => {
    // Attach utility function to window for modal closing via onclick attribute
    window.showMessageModal = showMessageModal; 
    
    loadDarkModePreference();
    setupEventListeners();
    await setupFirebase(); // Start the Firebase auth and data loading process
};
</script>
</body>
</html>
