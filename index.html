<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
    <title>Timetable App</title>
    <style>
        /* ** THEME VARIABLES (Light Mode Default) ** */
        :root{
            --bg: #ffffff;
            --text: #111111;
            --card: #f7f7f8;
            --card-border: #eee;
            --muted: #9b9b9b;
            --input-bg: white;
            --input-border: #111;
            --primary-btn-bg: #111;
            --primary-btn-text: white;
            --secondary-btn-bg: #fff;
            --secondary-btn-border: #111;
            --yellow-light: #ffd54e;
            --soft-shadow: 0 6px 18px rgba(12,12,14,0.06);
            --radius: 14px;
            /* Person colors */
            --color-red: #f44336;
            --color-blue: #2196f3;
            --color-pink: #e91e63;
            --color-yellow: #ffeb3b;
            --color-darkgreen: #00796b;
            --color-purple: #9c27b0; /* Added */
            --color-orange: #ff9800; /* Added */
        }

        /* ** DARK MODE OVERRIDES ** */
        body.dark-mode {
            --bg: #111111;
            --text: #ffffff;
            --card: #222222;
            --card-border: #333;
            --muted: #888;
            --input-bg: #333;
            --input-border: #555;
            --primary-btn-bg: #f7f7f8;
            --primary-btn-text: #111;
            --secondary-btn-bg: #111;
            --secondary-btn-border: #888;
            --soft-shadow: 0 6px 18px rgba(0,0,0,0.4);
        }

        /* ** GLOBAL STYLES ** */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 0;
            transition: background-color 0.3s, color 0.3s;
            display: flex;
            justify-content: center;
            padding-top: 20px;
            padding-bottom: 20px;
        }

        .container {
            width: 100%;
            max-width: 400px;
            padding: 16px;
            box-sizing: border-box;
        }

        /* ** TYPOGRAPHY ** */
        h1 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .header-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        /* ** CARD/SECTION STYLES ** */
        .card {
            background-color: var(--card);
            border: 1px solid var(--card-border);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--soft-shadow);
        }

        .section-separator {
            margin: 15px 0 10px 0;
            border: none;
            border-top: 1px solid var(--card-border);
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text);
        }

        /* ** INPUTS AND SELECTS ** */
        select, input[type="text"] {
            width: 100%;
            padding: 12px;
            margin: 0;
            margin-bottom: 10px;
            border-radius: 8px;
            border: 1px solid var(--input-border);
            background-color: var(--input-bg);
            color: var(--text);
            box-sizing: border-box;
            transition: border-color 0.2s;
            appearance: none; /* Remove default styling */
        }
        select:focus, input[type="text"]:focus {
            outline: none;
            border-color: var(--primary-btn-bg);
        }

        .row {
            display: flex;
            gap: 10px;
        }
        .row > * {
            flex-grow: 1;
        }
        
        /* ** BUTTONS ** */
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s, box-shadow 0.2s, color 0.2s;
            width: 100%;
            box-sizing: border-box;
        }
        .btn-primary {
            background-color: var(--primary-btn-bg);
            color: var(--primary-btn-text);
        }
        .btn-primary:hover {
            opacity: 0.9;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .btn-secondary {
            background-color: var(--secondary-btn-bg);
            color: var(--text);
            border: 1px solid var(--input-border);
        }
        .btn-secondary:hover {
            opacity: 0.8;
        }
        
        /* ** DARK MODE TOGGLE ** */
        #darkModeToggle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--card);
            border: 1px solid var(--card-border);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            line-height: 1;
            transition: background-color 0.3s, border-color 0.3s;
        }
        #darkModeToggle:hover {
            background-color: var(--card-border);
        }
        
        /* ** Custom Alert Modal ** */
        #confirmModal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            box-sizing: border-box;
        }
        .alert-content {
            background-color: var(--card);
            padding: 20px;
            border-radius: var(--radius);
            box-shadow: var(--soft-shadow);
            max-width: 300px;
            width: 100%;
            text-align: center;
        }
        .alert-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .alert-content p {
            margin-bottom: 20px;
            line-height: 1.5;
        }
        .modalClose {
            cursor: pointer;
            font-size: 24px;
            font-weight: 300;
            line-height: 1;
            color: var(--muted);
        }
        .modalClose:hover {
            color: var(--text);
        }

        /* ** Daily Schedule Modal ** */
        .scheduleModalBack {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            display: none; /* Controlled by JS */
            align-items: center;
            justify-content: center;
            padding: 10px;
            box-sizing: border-box;
        }
        .scheduleModal {
            background-color: var(--card);
            border-radius: var(--radius);
            box-shadow: var(--soft-shadow);
            max-width: 400px;
            width: 100%;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }
        .scheduleHeader {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid var(--card-border);
        }
        #modalScheduleContent {
            padding: 20px;
            overflow-y: auto;
        }
        .schedule-table {
            width: 100%;
            border-collapse: collapse;
        }
        .schedule-table th, .schedule-table td {
            padding: 12px;
            text-align: left;
        }
        .schedule-table thead th {
            font-weight: 700;
            color: var(--muted);
            border-bottom: 2px solid var(--card-border);
            position: sticky;
            top: 0;
            background-color: var(--card);
            z-index: 10;
        }
        .schedule-table tbody tr {
            border-bottom: 1px solid var(--card-border);
            transition: background-color 0.1s;
        }
        .schedule-table tbody tr:last-child {
            border-bottom: none;
        }
        .schedule-row {
            display: table-row;
        }
        .period-col {
            font-weight: 700;
            width: 80px;
        }
        
        /* ** Catchphrase section styles ** */
        .catchphrase-section {
            padding: 10px 0;
        }
        #refreshTag {
            font-size: 16px;
            font-style: italic;
            cursor: pointer;
            display: block;
            margin-bottom: 10px;
            min-height: 20px;
            text-align: center;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* ** Color-specific text classes for consistency ** */
        .color-text-red { color: var(--color-red); }
        .color-text-blue { color: var(--color-blue); }
        .color-text-pink { color: var(--color-pink); }
        .color-text-yellow { color: var(--color-yellow); }
        .color-text-darkgreen { color: var(--color-darkgreen); }
        .color-text-purple { color: var(--color-purple); }
        .color-text-orange { color: var(--color-orange); }

        .color-border-red { border-left: 4px solid var(--color-red); }
        .color-border-blue { border-left: 4px solid var(--color-blue); }
        .color-border-pink { border-left: 4px solid var(--color-pink); }
        .color-border-yellow { border-left: 4px solid var(--color-yellow); }
        .color-border-darkgreen { border-left: 4px solid var(--color-darkgreen); }
        .color-border-purple { border-left: 4px solid var(--color-purple); }
        .color-border-orange { border-left: 4px solid var(--color-orange); }

        /* Ensure selects and buttons are consistent on mobile */
        @media (max-width: 500px) {
            .row {
                flex-direction: column;
                gap: 0;
            }
            .row > * {
                margin-bottom: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header-section">
            <div style="flex-grow:1;">
                <h1>Timetable Finder</h1>
                <p id="userIdDisplay" style="font-size:12px; margin:0; color:var(--muted)">Connecting...</p>
            </div>
            <button id="darkModeToggle" class="btn-secondary" title="Toggle Dark Mode">
                ðŸŒ™
            </button>
        </div>

        <!-- Catchphrases Section (Personal/Private Data) -->
        <div class="card">
            <div class="catchphrase-section">
                <label>Daily Catchphrase (Click to Refresh)</label>
                <span id="refreshTag">Loading your phrases...</span>
            </div>
            
            <div class="section-separator"></div>

            <label>Add a new phrase</label>
            <div class="row">
                <input type="text" id="newPhraseInput" placeholder="E.g., Another day, another lesson...">
                <button id="addPhraseBtn" class="btn btn-primary" style="flex-grow:0; width:100px;">Add</button>
            </div>
        </div>

        <!-- Timetable Finder Section (Shared/Public Data) -->
        <div class="card">
            <h2>Timetable Lookup</h2>

            <!-- Find Single Lesson -->
            <div style="padding-bottom:12px;">
                <label>Who has what, when?</label>
                <div class="row">
                    <select id="whoSelect" title="Select Person"></select>
                    <select id="weekSelect" title="Select Week"></select>
                </div>
                <div class="row">
                    <select id="daySelect" title="Select Day"></select>
                    <select id="periodSelect" title="Select Period">
                        <option value="1">Period 1</option>
                        <option value="2">Period 2</option>
                        <option value="3">Period 3</option>
                        <option value="4">Period 4</option>
                        <option value="5">Period 5</option>
                    </select>
                </div>
                <button id="findBtn" class="btn btn-primary" style="margin-top:10px;">Find Lesson</button>
            </div>

            <div class="section-separator"></div>

            <!-- Show Full Day Schedule -->
            <div style="padding:12px 0;">
                <div>
                    <label>What do I have today?</label>
                    <div class="row">
                        <select id="whoSelect2" title="Select Person"></select>
                        <select id="weekSelect2" title="Select Week"></select>
                    </div>
                    <select id="daySelect2" title="Select Day" style="margin-top:8px;width:100%"></select>
                    <button id="whatBtn" class="btn btn-primary" style="margin-top:10px">Show my day</button>
                </div>
            </div>
        </div>

        <div style="text-align:center; color:var(--muted); font-size:13px; margin-top:8px">Built by Alessandro 2025</div>
    </div>

    <!-- Custom Modal for Alerts/Confirmations (hidden by default) -->
    <div id="confirmModal" style="display:none;"></div>

    <!-- Schedule Display Modal (hidden by default) -->
    <div id="scheduleModalBack" class="scheduleModalBack">
        <div id="scheduleModal" class="scheduleModal">
            <div class="scheduleHeader">
                <h3 id="scheduleTitle" style="margin:0;">Schedule</h3>
                <span id="scheduleClose" class="modalClose">&times;</span>
            </div>
            <div id="modalScheduleContent">
                <!-- Schedule rows populated by JavaScript -->
            </div>
        </div>
    </div>

<!-- The script that handles all the Firebase data, button clicks, and logic -->
<script type="module">
// Firebase Imports (MUST use cdn links provided by the environment)
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, doc, setDoc, onSnapshot, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

// Global Variables
let db;
let auth;
let userId = null;
let isAuthReady = false;
let peopleData = []; // User list derived from timetableData keys
let timetableData = {}; // Timetable data fetched from Firestore
let currentCatchphrases = []; // Catchphrases fetched from Firestore

// --- Configuration and Initialization ---

// Mandatory Canvas environment variables
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

// Mock Data (Used until Firestore data loads or if data is missing)
const MOCK_PEOPLE = [
    { id: 'mockuser', name: 'MOCK USER', color: 'var(--color-red)' },
];
const MOCK_TIMETABLE = {
    "MOCK USER": {
        "color": "red",
        "Week 1": { "Monday": ["Business", "Sociology", "Psychology", "Period 4", "Period 5"] },
        "Week 2": { "Monday": ["Business", "Sociology", "Psychology", "Business Lesson 10", "Media"] }
    }
};


// --- Utility Functions ---

/**
 * Custom safe display function for non-critical messages, avoiding native alerts.
 * @param {string} title
 * @param {string} message
 */
const showCustomAlert = (title, message) => {
    const modal = document.getElementById('confirmModal');
    modal.style.display = 'flex'; // Use flex for centering
    modal.innerHTML = `
        <div class="alert-content">
            <div class="alert-header">
                <h3>${title}</h3>
                <span class="modalClose" onclick="document.getElementById('confirmModal').style.display='none'">&times;</span>
            </div>
            <p>${message}</p>
            <button class="btn btn-primary" onclick="document.getElementById('confirmModal').style.display='none'">OK</button>
        </div>
    `;
};


// --- Firebase & Data Listeners ---

/**
 * Sets up Firebase initialization and authentication.
 */
const setupFirebase = async () => {
    if (!firebaseConfig) {
        console.error("Firebase config is missing. Cannot initialize.");
        showCustomAlert("Error", "Firebase configuration is missing. The app cannot load data.");
        return;
    }

    setLogLevel('debug');
    const app = initializeApp(firebaseConfig);
    db = getFirestore(app);
    auth = getAuth(app);

    // 1. Authentication
    if (initialAuthToken) {
        try {
            await signInWithCustomToken(auth, initialAuthToken);
        } catch (error) {
            console.error("Error signing in with custom token:", error);
            await signInAnonymously(auth);
        }
    } else {
        await signInAnonymously(auth);
    }

    // 2. Auth State Listener
    onAuthStateChanged(auth, (user) => {
        if (user) {
            userId = user.uid;
            isAuthReady = true;
            console.log("Firebase Auth Ready. User ID:", userId);

            // Start listening for data now that we are authenticated
            setupTimetableListener();
            setupCatchphraseListener();
            updateUserIdUI();
        } else {
            console.log("No user signed in.");
            userId = null;
            isAuthReady = true;
        }
    });
};

/**
 * Sets up real-time listener for the Timetable data from Firestore.
 * This is updated to use the direct path 'timetable/data' based on your screenshot.
 */
const setupTimetableListener = () => {
    if (!db || !isAuthReady) {
        console.error("Database not ready for Timetable Listener.");
        return;
    }

    // *** PATH FOR PUBLIC/SHARED DATA ***
    const timetableDocRef = doc(db, `timetable/data`);

    onSnapshot(timetableDocRef, (docSnap) => {
        if (docSnap.exists()) {
            timetableData = docSnap.data();
            console.log("Timetable Data updated from Firestore:", timetableData);
            
            // Re-populate data structures and UI based on new timetableData
            peopleData = Object.keys(timetableData).map(name => ({
                id: name.toLowerCase(),
                name: name,
                // Ensure color field exists in the data, or default to 'red'
                color: `var(--color-${timetableData[name].color || 'red'})` 
            }));
            
            // If data is empty after fetch, use mock data
            if (peopleData.length === 0) {
                 timetableData = MOCK_TIMETABLE; 
                 peopleData = MOCK_PEOPLE;
                 console.log("Firestore data was empty, switching to mock data.");
            }

            populateSelects();

        } else {
            console.warn("No timetable data found at 'timetable/data'. Using mock data.");
            // Fallback to mock data if the document is missing
            timetableData = MOCK_TIMETABLE; 
            peopleData = MOCK_PEOPLE;
            populateSelects();
            showCustomAlert("Setup Warning", "Timetable data not found in Firestore at `timetable/data`. Using mock data.");
        }
    }, (error) => {
        console.error("Error fetching timetable data:", error);
        showCustomAlert("Data Error", "Could not load the shared timetable data from Firestore. Check console for details.");
    });
};

/**
 * Sets up real-time listener for the user's catchphrases from Firestore.
 */
const setupCatchphraseListener = () => {
    if (!db || !userId) {
        // If not ready, this will be called again once auth is complete
        return;
    }

    // *** PATH FOR PRIVATE/PERSONAL DATA ***
    // Path: /artifacts/{appId}/users/{userId}/catchphrases/list
    const catchphraseDocRef = doc(db, `artifacts/${appId}/users/${userId}/catchphrases/list`);

    onSnapshot(catchphraseDocRef, (docSnap) => {
        if (docSnap.exists()) {
            // Data is an object, typically { phrases: ["...", "..."] }
            currentCatchphrases = docSnap.data().phrases || [];
            console.log("Catchphrases updated from Firestore:", currentCatchphrases.length, "phrases");
        } else {
            // Document doesn't exist, initialize with an empty array
            currentCatchphrases = [];
            console.log("No catchphrase document found. Initializing storage.");
        }
        updateCatchphraseUI(); // Always update UI after data change
    }, (error) => {
        console.error("Error fetching catchphrases:", error);
    });
};

/**
 * Updates the UI with the current user ID.
 */
const updateUserIdUI = () => {
    const userDisplay = document.getElementById('userIdDisplay');
    if (userDisplay && userId) {
        // Truncate for display, but full ID is in the console log
        const displayId = userId.substring(0, 8) + '...'; 
        userDisplay.textContent = `User: ${displayId}`;
    } else if (userDisplay) {
         userDisplay.textContent = `User: Not Signed In`;
    }
}


// --- Timetable Logic ---

/**
 * Populates the <select> elements for people, weeks, and days.
 */
const populateSelects = () => {
    const whoSelects = [document.getElementById('whoSelect'), document.getElementById('whoSelect2')];
    const weekSelects = [document.getElementById('weekSelect'), document.getElementById('weekSelect2')];
    const daySelects = [document.getElementById('daySelect'), document.getElementById('daySelect2')];

    if (peopleData.length === 0) {
        // No data, keep selects empty or show error
        console.warn("No people data to populate selects.");
        return;
    }

    // 1. People Selects
    whoSelects.forEach(select => {
        select.innerHTML = '';
        peopleData.forEach(person => {
            const option = document.createElement('option');
            option.value = person.name;
            option.textContent = person.name;
            select.appendChild(option);
        });
    });
    
    // Determine available weeks (use the first person's structure as reference)
    const firstPersonName = peopleData[0].name;
    const availableWeeks = timetableData[firstPersonName] 
        ? Object.keys(timetableData[firstPersonName]).filter(key => key.startsWith('Week'))
        : ['Week 1', 'Week 2']; // Fallback

    // 2. Week Selects
    weekSelects.forEach(select => {
        select.innerHTML = '';
        availableWeeks.forEach(week => {
            const option = document.createElement('option');
            option.value = week;
            option.textContent = week;
            select.appendChild(option);
        });
    });

    // Determine available days (use Week 1 of the first person as reference)
    const firstWeek = availableWeeks[0];
    const availableDays = (firstWeek && timetableData[firstPersonName] && timetableData[firstPersonName][firstWeek]) 
        ? Object.keys(timetableData[firstPersonName][firstWeek])
        : ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday']; // Fallback
        
    // 3. Day Selects
    daySelects.forEach(select => {
        select.innerHTML = '';
        availableDays.forEach(day => {
            const option = document.createElement('option');
            option.value = day;
            option.textContent = day;
            select.appendChild(option);
        });
    });
};


/**
 * Handles the 'Find Lesson' button click.
 */
const handleFindLesson = () => {
    const personName = document.getElementById('whoSelect').value;
    const week = document.getElementById('weekSelect').value;
    const day = document.getElementById('daySelect').value;
    const period = parseInt(document.getElementById('periodSelect').value);

    const personSchedule = timetableData[personName];

    if (!personSchedule || !personSchedule[week] || !personSchedule[week][day]) {
        showCustomAlert("Missing Data", `Schedule data for ${personName}, ${week}, ${day} is missing. Please check Firestore.`);
        return;
    }

    const lessons = personSchedule[week][day];
    const lesson = lessons[period - 1]; // Period 1 is index 0
    const colorClass = personSchedule.color || 'red';

    if (lesson && lesson.trim() !== '') {
        showCustomAlert(
            `Lesson for ${personName}`,
            `<span class="color-text-${colorClass}">**${personName}** has **${lesson}** in **${week}, ${day}, Period ${period}**.</span>`
        );
    } else {
        showCustomAlert(
            "Free Period",
            `<span class="color-text-${colorClass}">${personName} has a **Free Period** in **${week}, ${day}, Period ${period}**.</span>`
        );
    }
};

/**
 * Handles the 'Show My Day' button click.
 */
const handleShowDailySchedule = () => {
    const personName = document.getElementById('whoSelect2').value;
    const week = document.getElementById('weekSelect2').value;
    const day = document.getElementById('daySelect2').value;

    const personSchedule = timetableData[personName];

    if (!personSchedule || !personSchedule[week] || !personSchedule[week][day]) {
        showCustomAlert("Missing Data", `Schedule data for ${personName}, ${week}, ${day} is missing. Please check Firestore.`);
        return;
    }

    const lessons = personSchedule[week][day];
    const colorClass = personSchedule.color || 'red';
    const contentDiv = document.getElementById('modalScheduleContent');
    contentDiv.innerHTML = ''; // Clear previous content

    const table = document.createElement('table');
    table.className = 'schedule-table';
    table.innerHTML = `
        <thead>
            <tr>
                <th>Period</th>
                <th>Subject</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    `;
    const tbody = table.querySelector('tbody');

    lessons.forEach((lesson, index) => {
        const period = index + 1;
        // Handle empty strings or nulls from data gracefully
        const subject = (lesson && lesson.trim() !== '') ? lesson : 'Free Period';
        
        const row = document.createElement('tr');
        // Apply class based on the person's color for styling
        row.className = `schedule-row color-border-${colorClass}`;
        row.innerHTML = `
            <td class="period-col">P${period}</td>
            <td class="lesson-col">${subject}</td>
        `;
        tbody.appendChild(row);
    });

    // Update modal header
    document.getElementById('scheduleTitle').textContent = `${personName}'s Day: ${day} (${week})`;

    // Insert the table and show the modal
    contentDiv.appendChild(table);
    document.getElementById('scheduleModalBack').style.display = 'flex'; // Use flex to center the modal
};


// --- Catchphrase Logic (Personal Data) ---

/**
 * Updates the UI display for the random catchphrase.
 */
const updateCatchphraseUI = () => {
    const refreshTag = document.getElementById('refreshTag');
    const catchphraseCount = currentCatchphrases.length;

    if (catchphraseCount === 0) {
        refreshTag.textContent = "Start by adding a catchphrase!";
        return;
    }
    
    // Pick a random phrase
    const randomIndex = Math.floor(Math.random() * catchphraseCount);
    refreshTag.textContent = currentCatchphrases[randomIndex];
    
    // Add a simple animation class for visual feedback
    refreshTag.classList.remove('fade-in');
    void refreshTag.offsetWidth; // Trigger reflow
    refreshTag.classList.add('fade-in');
};

/**
 * Handles adding a new catchphrase to the user's list in Firestore.
 */
const handleAddPhrase = async () => {
    const input = document.getElementById('newPhraseInput');
    const newPhrase = input.value.trim();

    if (newPhrase === "") {
        showCustomAlert("Hold up!", "Please enter a phrase before adding it.");
        return;
    }

    if (!db || !userId) {
        showCustomAlert("Error", "Authentication not complete. Cannot save phrase.");
        return;
    }

    if (currentCatchphrases.includes(newPhrase)) {
        showCustomAlert("Duplicate", "You've already saved that exact phrase!");
        return;
    }

    const catchphraseDocRef = doc(db, `artifacts/${appId}/users/${userId}/catchphrases/list`);

    try {
        // Use arrayUnion to safely add the new phrase to the array
        await setDoc(catchphraseDocRef, { 
            phrases: arrayUnion(newPhrase) 
        }, { merge: true });
        
        input.value = ''; // Clear input on success
        showCustomAlert("Success", `Catchphrase "${newPhrase}" added!`);

    } catch (e) {
        console.error("Error adding catchphrase:", e);
        showCustomAlert("Save Error", "Failed to save the phrase to your storage.");
    }
};


// --- Dark Mode Logic ---

const loadDarkModePreference = () => {
    // Check if the user has a preference saved, or respects the system preference
    const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    const storedPreference = localStorage.getItem('darkMode');
    
    let isDarkMode = false;
    if (storedPreference !== null) {
        isDarkMode = storedPreference === 'true';
    } else if (prefersDark) {
        isDarkMode = true;
    }

    if (isDarkMode) {
        document.body.classList.add('dark-mode');
    }
};

const toggleDarkMode = () => {
    const isDarkMode = document.body.classList.toggle('dark-mode');
    localStorage.setItem('darkMode', isDarkMode);
};


// --- Event Listeners and Execution ---

/**
 * Sets up all necessary DOM event listeners.
 */
const setupEventListeners = () => {
    // Timetable Features
    document.getElementById('findBtn').addEventListener('click', handleFindLesson);

    // Catchphrase Features
    document.getElementById('addPhraseBtn').addEventListener('click', handleAddPhrase);
    document.getElementById('refreshTag').addEventListener('click', updateCatchphraseUI);

    // Daily Schedule Feature
    document.getElementById('whatBtn').addEventListener('click', handleShowDailySchedule);
    document.getElementById('scheduleClose').addEventListener('click', () => {
        document.getElementById('scheduleModalBack').style.display = 'none';
    });

    // Dark Mode Toggle
    document.getElementById('darkModeToggle').addEventListener('click', toggleDarkMode);
};

// --- Execution ---

window.onload = async () => {
    loadDarkModePreference();
    setupEventListeners();
    await setupFirebase(); // Start the Firebase auth and data loading process
};
</script>
</body>
</html>
